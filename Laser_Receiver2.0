#include <math.h>

long bitLength = 50000;
int input = 34;
int valueTolerance = 3200; //logic 0 is when analogRead() > tolerance, logic 1 is when analogRead() < tolerance
int durationTolerance = 5000;
int edgeTolerance = 300;
struct data{
  int value;
  long duration;
};

data pulse;
TaskHandle_t Task1;
QueueHandle_t commandQueue;


void setup() {
  Serial.begin(115200);
  commandQueue = xQueueCreate(10, sizeof(data));
  Serial.println("Started");
  xTaskCreatePinnedToCore(
    timeTask,
    "timeTask",
    10000,
    NULL,
    0,
    &Task1,
    0
  );
}

void timeTask(void * parameter){
  unsigned long start;
  unsigned long stop;
  bool checkingDuration = false;

  for(;;){
    int currentValue = analogRead(input);

    if (!checkingDuration){
      pulse.value = currentValue;
      checkingDuration = true;
      start = micros();
    }

    if (checkingDuration && abs(currentValue - pulse.value) > edgeTolerance){
      stop = micros();
      pulse.duration = stop - start;
      checkingDuration = false;
      xQueueSend(commandQueue, &pulse, portMAX_DELAY);
    }

  }
}


bool synced = false;
data incoming;
int bitCounter = - 1;
int charNumber = 0;
void loop() {
  if(xQueueReceive(commandQueue, &incoming, portMAX_DELAY)){
    
    if(synced){
      //Serial.println("synced");
      if(labs(incoming.duration - bitLength) < durationTolerance){ // if not a stop bit
        bitCounter++;
        if(bitCounter > 0 && bitCounter < 9 && incoming.value < valueTolerance){
        
          charNumber |= (1 << (8 - bitCounter)); 
        }
      }
      else if(labs(incoming.duration - (1.5 * bitLength)) < durationTolerance){ //if stop bit
        if (bitCounter != 9){
          synced = false;
          charNumber = 0;
          Serial.println("Lost sync: bitCounter exceeded 9");
        }
        else{
          bitCounter = -1;
          Serial.print((char)(charNumber));
          charNumber = 0;
        }
      }
      else if (labs(incoming.duration - (1.5 * bitLength)) > valueTolerance){
        long remaining = incoming.duration;
        int count = 0;
        while(remaining >= bitLength * 0.5){
          remaining = remaining - bitLength;
          count++;
          bitCounter++;
          if(incoming.value < 3000 && bitCounter < 9){
            charNumber |= (1 << (8 - bitCounter));
          }
          if(bitCounter == 9 && labs(incoming.duration - bitLength) < durationTolerance){
            charNumber = 0;
            bitCounter = -1;
          }
        }
      }
    }

    if (!synced && labs(incoming.duration - (1.5 * bitLength)) < durationTolerance && incoming.value > valueTolerance){
      synced = true;
      bitCounter = -1;
      Serial.println("Synced: start of frame detected");
    }

    if(bitCounter > 9){
      synced = false;
      Serial.println("Lost sync: bitCounter exceeded 9");
      bitCounter = -1;
      charNumber = 0;
    }
  }
}
